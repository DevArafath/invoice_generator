<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Generator</title>
    <style>
        /* Basic Reset & Defaults */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { height: 100%; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            background-color: #f4f4f4;
            color: #333;
            padding: 20px;
            min-height: 100%;
            font-size: 16px; /* Base font size */
            -webkit-text-size-adjust: 100%; /* Prevent font scaling */
            -moz-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }
    
        /* Invoice Container */
        #invoice-container {
            display: flex;
            flex-direction: column;
            min-height: calc(100vh - 40px); /* Adjust based on body padding */
            max-width: 850px;
            margin: 20px auto;
            background-color: #fff;
            border: 1px solid #ccc;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        #invoice-main-content {
            flex-grow: 1;
            padding: 30px 40px;
        }
    
        /* Header/Footer Images */
        .invoice-header-img, .invoice-footer-img {
            width: 100%; display: block; height: auto;
        }
        .invoice-header-img { margin-bottom: 30px; }
        .invoice-footer-img { margin-top: auto; padding: 0 40px 30px 40px; }
    
        /* Invoice Meta Info */
        .invoice-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        .invoice-meta label {
            display: block; font-weight: 600; margin-bottom: 6px;
            color: #555; font-size: 0.9em;
        }
        .invoice-meta input[type="text"],
        .invoice-meta input[type="date"],
        .invoice-meta textarea {
            width: 100%; padding: 10px 12px; border: 1px solid #ccc;
            border-radius: 5px; font-size: 1em; line-height: 1.4;
            background-color: #fdfdfd;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .invoice-meta input:focus, .invoice-meta textarea:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
            outline: none;
        }
        .invoice-meta textarea {
            height: 100px; min-height: 50px; resize: vertical; overflow: auto;
        }
    
        /* Items Table Wrapper (for horizontal scroll on mobile) */
        .invoice-items-wrapper {
            width: 100%;
            overflow-x: auto; /* Enable horizontal scroll */
            margin-bottom: 30px;
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }
    
        /* Items Table */
        #invoice-items {
            width: 100%;
            min-width: 600px; /* Prevent excessive squeezing before scroll activates */
            border-collapse: collapse;
            /* margin-bottom: 30px; Moved to wrapper */
        }
        #invoice-items th, #invoice-items td {
            border: 1px solid #ddd; padding: 12px 15px;
            text-align: left; vertical-align: top;
        }
        #invoice-items th {
            background-color: #f8f9fa; font-weight: 600;
            font-size: 0.9em; color: #444; white-space: nowrap;
        }
        #invoice-items td.number, #invoice-items th.number { text-align: right; }
    
        /* Inputs inside table */
        #invoice-items input[type="number"],
        #invoice-items textarea.item-name {
            width: 100%; padding: 8px 10px; border: 1px solid #ccc;
            border-radius: 5px; font-size: 1em; line-height: 1.4;
            vertical-align: top;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        #invoice-items input:focus, #invoice-items textarea:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
            outline: none;
        }
        #invoice-items td.number input {
            text-align: right;
            width: 80px; /* Allow input to be reasonably sized */
            min-width: 60px; /* Absolute minimum */
        }
        #invoice-items textarea.item-name {
            resize: vertical; overflow: hidden;
            min-height: calc(1.4em + 16px); height: auto;
            background-color: #fff;
        }
    
        /* Delete Button */
        .delete-item-btn {
            background-color: #dc3545; color: white; border: none;
            width: 30px; height: 30px; line-height: 30px; text-align: center;
            padding: 0; border-radius: 50%; cursor: pointer;
            font-size: 1em; font-weight: bold; display: block; margin: 0 auto;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        .delete-item-btn:hover { background-color: #c82333; transform: scale(1.1); }
        .delete-item-btn:active { transform: scale(0.95); }
    
        /* Totals Section */
        #invoice-items tfoot td {
            border: 1px solid #ddd; border-top-width: 2px; border-top-color: #aaa;
            text-align: right; font-weight: bold; padding: 10px 15px;
            white-space: nowrap; /* Prevent totals labels from wrapping */
        }
        #invoice-items tfoot tr:first-child td { border-top: 2px solid #aaa; }
        #invoice-items tfoot tr td:first-child { /* Label cell */
            text-align: right; font-weight: bold; color: #333;
        }
         /* Hide empty Action cell in footer */
        #invoice-items tfoot td:last-child {
            border-left: none; border-bottom: none; border-right: none;
            background: none; /* Make it truly invisible */
        }
        #invoice-items tfoot tr:not(:first-child) td:last-child { border-top: none;}
    
    
        /* Action Buttons */
        .action-buttons {
            margin-top: 20px; text-align: right; padding-bottom: 20px;
            display: flex; flex-wrap: wrap; justify-content: flex-end;
            gap: 10px;
        }
        .action-buttons button {
            color: white; padding: 10px 20px; border: none;
            border-radius: 5px; cursor: pointer; font-size: 1em;
            transition: background-color 0.2s ease, box-shadow 0.2s ease, transform 0.1s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); font-weight: 500;
        }
        .action-buttons button:hover { box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); }
        .action-buttons button:active { transform: translateY(1px); box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }
    
        /* Specific Button Colors */
        #add-item-btn { background-color: #28a745; }
        #add-item-btn:hover { background-color: #218838; }
        #add-discount-btn { background-color: #ffc107; color: #212529; }
        #add-discount-btn:hover { background-color: #e0a800; }
        #change-company-btn { background-color: #17a2b8; }
        #change-company-btn:hover { background-color: #138496; }
        #print-btn { background-color: #6c757d; }
        #print-btn:hover { background-color: #5a6268; }
    
        /* Terms and Conditions */
        .terms-conditions {
            margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee;
            font-size: 0.9em; color: #555;
        }
        .terms-conditions h4 {
            margin-bottom: 8px; font-size: 1.15em; color: #333; font-weight: 600;
        }
    
        /* --- Modal Styles (Shared & Specific) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none; justify-content: center; align-items: center;
            z-index: 1000; padding: 20px;
        }
        .modal-content {
            background-color: #fff; padding: 30px; border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 100%; max-width: 480px;
            display: flex; flex-direction: column;
        }
        .modal-content h2 { margin-top: 0; margin-bottom: 25px; color: #333; text-align: center; font-weight: 600; }
        .modal-buttons { text-align: right; margin-top: 25px; }
        .modal-buttons button {
            padding: 10px 20px; border: none; border-radius: 5px;
            cursor: pointer; font-size: 1em; margin-left: 10px;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
            font-weight: 500;
        }
        .modal-buttons button:first-child { margin-left: 0; }
    
        /* Item Modal Specifics */
        #item-modal-content label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.95em; color: #444; }
        #item-modal-content input[type="text"],
        #item-modal-content input[type="number"] {
            width: 100%; padding: 10px 12px; margin-bottom: 15px;
            border: 1px solid #ccc; border-radius: 5px; font-size: 1em;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        #item-modal-content input:focus {
            border-color: #28a745; box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.25); outline: none;
        }
        #item-modal-save-btn { background-color: #28a745; color: white; }
        #item-modal-save-btn:hover { background-color: #218838; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        #item-modal-cancel-btn { background-color: #dc3545; color: white; }
        #item-modal-cancel-btn:hover { background-color: #c82333; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    
        /* Company Modal Specifics */
        #company-options-list { max-height: 300px; overflow-y: auto; margin-bottom: 20px; border: 1px solid #eee; padding: 10px; border-radius: 5px; }
        .company-option { display: block; padding: 10px 15px; margin-bottom: 5px; cursor: pointer; border-radius: 4px; transition: background-color 0.2s ease; border: 1px solid transparent; }
        .company-option:hover { background-color: #f0f0f0; }
        .company-option input[type="radio"] { margin-right: 12px; vertical-align: middle; transform: scale(1.1); accent-color: #007bff; }
        .company-option span { vertical-align: middle; }
        .company-option:has(input:checked) { background-color: #e7f3ff; border-color: #b8d8ff; }
    
        #company-modal-ok-btn { background-color: #007bff; color: white; }
        #company-modal-ok-btn:hover { background-color: #0056b3; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        #company-modal-cancel-btn { background-color: #6c757d; color: white; }
        #company-modal-cancel-btn:hover { background-color: #5a6268; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    
    
        /* =============================== */
        /* === MOBILE RESPONSIVE STYLES === */
        /* =============================== */
        @media (max-width: 768px) { /* Tablet and smaller */
            body { padding: 10px; font-size: 15px; }
            #invoice-container { margin: 10px auto; max-width: 98%; border-radius: 6px; }
            #invoice-main-content { padding: 20px; }
            .invoice-footer-img { padding: 0 20px 20px 20px; }
    
            .invoice-meta { gap: 15px; margin-bottom: 30px; }
            .invoice-meta input, .invoice-meta textarea { padding: 8px 10px; }
    
            /* Adjust table padding slightly */
            #invoice-items th, #invoice-items td { padding: 10px; }
    
            /* Reduce button padding slightly */
             .action-buttons button { padding: 9px 18px; }
        }
    
        @media (max-width: 600px) { /* Mobile phones */
            body { padding: 5px; font-size: 14px; }
            #invoice-container { margin: 5px auto; max-width: 100%; border: none; box-shadow: none; border-radius: 0; }
            #invoice-main-content { padding: 15px; }
            .invoice-footer-img { padding: 0 15px 15px 15px; }
    
            /* Stack meta items */
            .invoice-meta { grid-template-columns: 1fr; gap: 15px; margin-bottom: 25px; }
    
            /* --- Mobile Table: Horizontal Scroll --- */
            /* The .invoice-items-wrapper handles the scroll */
            /* We mainly adjust padding/font inside the table */
            #invoice-items { min-width: 0; /* Allow table to shrink if content allows */ }
            #invoice-items th, #invoice-items td {
                padding: 8px 10px; /* Reduce padding */
                font-size: 0.95em; /* Slightly smaller font in table */
                white-space: nowrap; /* Prevent wrapping that might break layout */
            }
            #invoice-items td.number input { width: 70px; } /* Adjust input width */
             #invoice-items textarea.item-name {
                min-height: calc(1.4em + 10px); /* Adjust min-height based on smaller padding */
                font-size: inherit; /* Ensure textarea font size matches td */
                white-space: normal; /* ALLOW item name textarea to wrap */
             }
            #invoice-items td:first-child { /* Item description column */
                white-space: normal; /* Allow description cell itself to wrap if needed */
                min-width: 150px; /* Give description some minimum space */
            }
            #invoice-items tfoot td { padding: 8px 10px; }
    
    
            /* --- Responsive Action Buttons --- */
            .action-buttons {
                flex-direction: column; /* Stack buttons vertically */
                align-items: stretch; /* Make buttons full width */
                margin-top: 25px; padding-bottom: 15px; gap: 12px;
            }
            .action-buttons button {
                width: 100%; margin-left: 0; padding: 12px 15px; font-size: 1.05em;
            }
    
             /* --- Responsive Modals --- */
            .modal-content { padding: 20px; max-width: 95%; }
            .modal-buttons {
                 display: flex; flex-direction: column-reverse;
                 gap: 10px; margin-top: 20px;
            }
             .modal-buttons button { width: 100%; margin-left: 0; }
        }
    
    
        /* ============================ */
/* === PRINT STYLES (Revised) === */
/* ============================ */
@media print {
    @page {
        size: A4; /* Or Letter, etc. Define your page size */
        margin: 15mm; /* Define base page margins - adjust as needed */
        /* You can have specific margins: margin-top, margin-bottom, etc. */
    }

    html, body {
        height: 100% !important; /* CRITICAL: Force html/body to page height */
        min-height: 100% !important; /* Reinforce */
        background-color: #fff !important;
        padding: 0 !important;
        margin: 0 !important;
        font-size: 10pt;
        -webkit-print-color-adjust: exact !important; color-adjust: exact !important;
        display: flex; /* Make body a flex container too */
        flex-direction: column; /* Body arranges children vertically */
    }

    #invoice-container {
        width: 100% !important;
        max-width: 100% !important;
        min-height: 0 !important; /* Remove min-height screen constraint */
        height: auto; /* Let flex children determine height */
        flex-grow: 1; /* CRITICAL: Allow container to grow within body */
        margin: 0 !important;
        padding: 0 !important; /* Remove container padding if content has it */
        border: none !important;
        box-shadow: none !important;
        display: flex !important; /* Keep flex */
        flex-direction: column !important; /* Keep column direction */
        overflow: visible !important;
        border-radius: 0 !important;
        /* page-break-inside: avoid !important; REMOVE THIS - it conflicts with wanting footer at bottom if content is short */
    }

    #invoice-main-content {
        flex-grow: 1 !important; /* Allow main content to take available space */
        padding: 5mm 0 5mm 0 !important; /* Adjust padding - use page margin for sides */
        width: 100% !important; /* Takes width from container */
        height: auto; /* Let content determine its height */
        /* Add page-break-inside avoid *here* if you want to prevent the main content block itself from splitting */
        page-break-inside: avoid !important;
    }

    /* --- Header/Footer Print Placement --- */
    .invoice-header-img {
        display: block !important;
        width: 100% !important;
        margin: 0 !important; /* Remove margin */
        padding: 0 !important;
        /* Add some bottom margin if needed for space *below* the header */
        margin-bottom: 5mm !important;
        page-break-inside: avoid !important;
        flex-shrink: 0; /* Prevent header from shrinking */
    }

    .invoice-footer-img {
        display: block !important;
        width: 100% !important;
        margin: 0 !important; /* REMOVE ALL MARGINS INITIALLY */
        /* Add margin-top for space *above* the footer */
        margin-top: 5mm !important; /* Adjust as needed for visual spacing */
        padding: 0 !important;
        page-break-inside: avoid !important;
        page-break-before: auto;
        flex-shrink: 0; /* Prevent footer from shrinking */
        /* Position it at the end of the flex flow */
    }

    /* --- Hide elements not needed for print --- */
    .action-buttons, .modal-overlay, .delete-item-btn,
    #invoice-items thead th:last-child, /* Hide Action header */
    #invoice-items tbody td:last-child, /* Hide Action cell in body */
    #invoice-items tfoot td:last-child /* Hide Action cell in footer */
    {
        display: none !important;
    }

    /* Remove scroll wrapper for print */
    .invoice-items-wrapper { overflow: visible !important; margin-bottom: 10px !important; }

    /* Ensure table layout is standard for print */
    #invoice-items { width: 100% !important; min-width: 0 !important; border-collapse: collapse !important; border-spacing: 0 !important; }
    #invoice-items thead { display: table-header-group !important; }
    #invoice-items tbody, #invoice-items tfoot { display: table-row-group !important; }
    #invoice-items tr { display: table-row !important; page-break-inside: avoid !important; }

    /* --- Remove ALL Table Borders for Print --- */
    #invoice-items th, #invoice-items td {
        display: table-cell !important; width: auto !important;
        border: none !important; /* NO BORDERS */
        padding: 3px 5px !important; /* Reduced padding */
        font-size: 9.5pt !important;
        vertical-align: top !important;
        white-space: normal !important;
    }
    #invoice-items th { background-color: #f0f0f0 !important; font-weight: bold; padding: 4px 5px !important; }
    #invoice-items td.number, #invoice-items th.number { text-align: right !important; }

    /* Style Inputs/TextAreas for Print */
    /* ... (keep your input styles) ... */
    .invoice-meta input[type="text"], .invoice-meta input[type="date"], .invoice-meta textarea,
    #invoice-items input[type="number"], #invoice-items textarea.item-name {
        border: none !important; background-color: transparent !important; padding: 0 !important; margin: 0; box-shadow: none !important; outline: none !important; width: 100%; display: block; color: #000 !important; font-family: inherit !important; font-size: inherit !important; line-height: inherit !important; -webkit-appearance: none; -moz-appearance: none; appearance: none;
    }
    .invoice-meta textarea, #invoice-items textarea.item-name { resize: none !important; overflow: hidden !important; height: auto !important; white-space: pre-wrap; word-wrap: break-word; }
    #invoice-items input[type="number"] { text-align: right; width: auto; display: inline; -moz-appearance: textfield; }

    /* Table Footer Specifics for Print (No Borders, subtle spacing) */
    #invoice-items tfoot { margin-top: 3mm !important; }
    #invoice-items tfoot td {
        border: none !important; /* Ensure no borders */
        border-top: 1pt solid #bbb !important; /* Keep subtle top border ONLY */
        padding-top: 4px !important;
        padding-bottom: 4px !important;
        font-weight: bold;
    }
    #invoice-items tfoot tr:not(:first-child) td { border-top: none !important; }
    #invoice-items tfoot tr:first-child td { border-top: 1pt solid #999 !important; }

    .terms-conditions {
        border-top: none !important;
        margin-top: 5mm !important;
        padding-top: 0 !important;
        font-size: 8.5pt !important;
        page-break-inside: avoid !important;
        flex-shrink: 0; /* Prevent terms from shrinking if part of main flex flow */
        /* If terms are *outside* #invoice-main-content but inside #invoice-container: */
        /* margin-bottom: 5mm; /* Add space before footer */
    }

} /* End @media print */
    
    </style>
</head>
<body>

    <div id="invoice-container">
        <!-- Wrap everything EXCEPT the footer image -->
        <div id="invoice-main-content">

            <!-- 1. Header Image (Source will be set by JS) -->
            <img src="" alt="Company Letterhead Header" id="invoice-header" class="invoice-header-img">

            <!-- 2. Invoice Meta Information -->
            <section class="invoice-meta">
                <div> <label for="invoice-number">Invoice #</label> <input type="text" id="invoice-number" placeholder="e.g., INV-001"> </div>
                <div> <label for="invoice-date">Date Issued</label> <input type="date" id="invoice-date"> </div>
                <div> <label for="due-date">Due Date</label> <input type="date" id="due-date"> </div>
                <div> <label for="client-details">Bill To:</label> <textarea id="client-details" placeholder="Client Name" rows="5"></textarea> </div>
            </section>

            <!-- 3. Invoice Items Table -->
            <div class="invoice-items-wrapper">
                <table id="invoice-items">
                    <thead>
                        <tr> <th>Item Description</th> <th class="number">Qty</th> <th class="number">Unit Price</th> <th class="number">Total</th> <th>Action</th> </tr>
                    </thead>
                    <tbody id="items-tbody"></tbody>
                    <tfoot id="items-tfoot">
                        <tr> <td colspan="3">Subtotal</td> <td id="subtotal" class="number">0.00</td> <td></td> </tr>
                        <tr id="discount-row" style="display: none;"> <td colspan="3">Discount (<span id="discount-percent">0</span>%)</td> <td id="discount-amount" class="number">0.00</td> <td></td> </tr>
                        <tr> <td colspan="3">Grand Total</td> <td id="grand-total" class="number">0.00</td> <td></td> </tr>
                    </tfoot>
                </table>
            </div> <!-- END WRAPPER DIV -->

             <!-- 4. Action Buttons -->
            <div class="action-buttons">
                <button id="add-item-btn">Add Item</button>
                <button id="add-discount-btn">Add Discount</button>
                <button id="change-company-btn">Change Company</button> <!-- New Button -->
                <button id="print-btn">Print / Save PDF</button>
            </div>

            <!-- 5. Terms and Conditions -->
            <section class="terms-conditions">
                <h4>Terms & Conditions</h4>
                <p> Sample terms: Payment due within 30 days. Overdue accounts may be subject to interest charges. Goods remain property of the seller until paid in full. </p>
            </section>

        </div> <!-- End #invoice-main-content -->

         <!-- 6. Footer Image (Source will be set by JS) -->
        <img src="" alt="Company Letterhead Footer" id="invoice-footer" class="invoice-footer-img">

    </div><!-- /#invoice-container -->


    <!-- Item Entry Modal -->
    <div id="item-modal-overlay" class="modal-overlay">
        <div id="item-modal-content" class="modal-content">
            <h2>Add Invoice Item</h2>
            <label for="modal-item-name">Item Description:</label>
            <input type="text" id="modal-item-name" placeholder="Enter item name or description">
            <label for="modal-item-qty">Quantity:</label>
            <input type="number" id="modal-item-qty" placeholder="1" min="0" step="any">
            <label for="modal-item-price">Unit Price:</label>
            <input type="number" id="modal-item-price" placeholder="0.00" min="0" step="0.01">
            <div class="modal-buttons">
                <button id="item-modal-save-btn">Save Item</button>
                <button id="item-modal-cancel-btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Company Selection Modal -->
    <div id="company-modal-overlay" class="modal-overlay">
        <div id="company-modal-content" class="modal-content">
            <h2>Select Company Profile</h2>
            <div id="company-options-list">
                <!-- Company options will be populated here by JS -->
            </div>
            <div class="modal-buttons">
                <button id="company-modal-ok-btn">OK</button>
                <button id="company-modal-cancel-btn">Cancel</button>
            </div>
        </div>
    </div>


    <script>
        // --- Configuration: Define Company Profiles ---
        // IMPORTANT: Make sure these paths are correct relative to your HTML file
        // and that the image files exist! Use the `img/` folder.
        const companyProfiles = [
            {
                name: "Default Company",
                header: "img/header_placeholder.png", // Default/fallback
                footer: "img/footer_placeholder.png"
            },
            {
                name: "Creative Solutions Ltd.",
                header: "./img/header.png",   // Example: create this file
                footer: "./img/footer1.png"    // Example: create this file
            },
            {
                name: "Tech Innovators Inc.",
                header: "img/tech_header.png",       // Example: create this file
                footer: "img/tech_footer.png"        // Example: create this file
            },
             {
                name: "Global Corp",
                header: "img/global_header.png",       // Example: create this file
                footer: "img/global_footer.png"        // Example: create this file
            },
             {
                name: "Green Energy Co.",
                header: "img/green_header.png",       // Example: create this file
                footer: "img/green_footer.png"        // Example: create this file
            },
            // Add more profiles as needed
        ];

        // --- DOM Elements ---
        const invoiceContainer = document.getElementById('invoice-container');
        const invoiceHeaderImg = document.getElementById('invoice-header'); // Get header img element
        const invoiceFooterImg = document.getElementById('invoice-footer'); // Get footer img element
        const invoiceNumberInput = document.getElementById('invoice-number');
        const invoiceDateInput = document.getElementById('invoice-date');
        const dueDateInput = document.getElementById('due-date');
        const clientDetailsInput = document.getElementById('client-details');
        const itemsTbody = document.getElementById('items-tbody');
        const addItemBtn = document.getElementById('add-item-btn');
        const addDiscountBtn = document.getElementById('add-discount-btn');
        const changeCompanyBtn = document.getElementById('change-company-btn'); // New button
        const printBtn = document.getElementById('print-btn');
        // Item Modal
        const itemModalOverlay = document.getElementById('item-modal-overlay');
        const itemModalSaveBtn = document.getElementById('item-modal-save-btn');
        const itemModalCancelBtn = document.getElementById('item-modal-cancel-btn');
        const modalItemName = document.getElementById('modal-item-name');
        const modalItemQty = document.getElementById('modal-item-qty');
        const modalItemPrice = document.getElementById('modal-item-price');
        // Company Modal
        const companyModalOverlay = document.getElementById('company-modal-overlay'); // New modal overlay
        const companyOptionsList = document.getElementById('company-options-list');   // New list container
        const companyModalOkBtn = document.getElementById('company-modal-ok-btn');     // New OK button
        const companyModalCancelBtn = document.getElementById('company-modal-cancel-btn'); // New Cancel button
        // Totals
        const subtotalEl = document.getElementById('subtotal');
        const discountRow = document.getElementById('discount-row');
        const discountPercentEl = document.getElementById('discount-percent');
        const discountAmountEl = document.getElementById('discount-amount');
        const grandTotalEl = document.getElementById('grand-total');

        // --- State ---
        let invoiceItems = [];
        let discountPercent = 0;
        let nextItemId = 1;
        let currentProfileName = companyProfiles[0].name; // Track current profile name, default to first

        // --- Utility Functions ---
        const formatCurrency = (amount) => { /* ... (same as before) ... */
             const num = Number(amount); return isNaN(num) ? '0.00' : num.toFixed(2); };
        const getInputValueAsNumber = (element) => { /* ... (same as before) ... */
             const value = element.value.trim(); if (value === '') return 0; const num = Number(value); return isNaN(num) || num < 0 ? 0 : num; };
        const getNextId = () => { /* ... (same as before) ... */
             const maxId = invoiceItems.reduce((max, item) => Math.max(max, item.id || 0), 0); nextItemId = Math.max(nextItemId, maxId + 1); return nextItemId++; };
        const autoGrowTextarea = (element) => { /* ... (same as before) ... */
             if (!element) return; const wasHidden = element.style.display === 'none'; if (wasHidden) element.style.display = ''; element.style.height = 'auto'; element.style.height = (element.scrollHeight + 1) + 'px'; if (wasHidden) element.style.display = 'none';};
        const getDefaultDate = () => { /* ... (same as before) ... */
             const today = new Date(); const year = today.getFullYear(); const month = String(today.getMonth() + 1).padStart(2, '0'); const day = String(today.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; };

        // --- Core Functions ---

        // Updates header/footer images based on the profile name
        const applyCompanyProfile = (profileName) => {
            const profile = companyProfiles.find(p => p.name === profileName) || companyProfiles[0]; // Fallback to default
            invoiceHeaderImg.src = profile.header;
            invoiceFooterImg.src = profile.footer;
            invoiceHeaderImg.alt = `${profile.name} Header`; // Update alt text
            invoiceFooterImg.alt = `${profile.name} Footer`; // Update alt text
            currentProfileName = profile.name; // Update state
            console.log("Applied profile:", currentProfileName);
        };

        // Recalculates totals
        const updateTotals = () => { /* ... (same as before, ensures saveDataToLocalStorage is called) ... */
            let currentSubtotal = 0;
            invoiceItems.forEach(item => { currentSubtotal += (item.qty || 0) * (item.price || 0); });
            const discountAmount = currentSubtotal * (discountPercent / 100);
            const grandTotal = currentSubtotal - discountAmount;
            subtotalEl.textContent = formatCurrency(currentSubtotal);
            discountAmountEl.textContent = formatCurrency(discountAmount);
            grandTotalEl.textContent = formatCurrency(grandTotal);
            discountPercentEl.textContent = discountPercent;
            discountRow.style.display = discountPercent > 0 ? '' : 'none';
            itemsTbody.querySelectorAll('tr').forEach(row => {
                const id = parseInt(row.dataset.id, 10);
                const item = invoiceItems.find(i => i.id === id);
                if (item) { const rowTotal = (item.qty || 0) * (item.price || 0); const totalCell = row.querySelector('.item-total'); if(totalCell) totalCell.textContent = formatCurrency(rowTotal); }
            });
            saveDataToLocalStorage();
        };

        // Renders a single item row
        const renderItemRow = (item) => { /* ... (same as before, textarea for name, event listeners) ... */
            const row = document.createElement('tr');
            row.dataset.id = item.id;
            const itemName = item.name || ''; const itemQty = item.qty || 0; const itemPrice = item.price || 0;
            row.innerHTML = `<td><textarea class="item-name" rows="1" placeholder="Item description">${itemName}</textarea></td> <td class="number"><input type="number" class="item-qty" value="${itemQty}" min="0" step="any"></td> <td class="number"><input type="number" class="item-price" value="${formatCurrency(itemPrice)}" min="0" step="0.01"></td> <td class="number item-total">${formatCurrency(itemQty * itemPrice)}</td> <td><button class="delete-item-btn" data-id="${item.id}">X</button></td>`;
            const nameTextarea = row.querySelector('.item-name'); const qtyInput = row.querySelector('.item-qty'); const priceInput = row.querySelector('.item-price');
            nameTextarea.addEventListener('input', () => { autoGrowTextarea(nameTextarea); updateItemData(item.id, 'name', nameTextarea.value); saveDataToLocalStorage(); });
            nameTextarea.addEventListener('focus', () => autoGrowTextarea(nameTextarea)); nameTextarea.addEventListener('blur', () => autoGrowTextarea(nameTextarea));
            qtyInput.addEventListener('input', () => { updateItemData(item.id, 'qty', getInputValueAsNumber(qtyInput), true); });
            priceInput.addEventListener('input', () => { const rawPrice = getInputValueAsNumber(priceInput); updateItemData(item.id, 'price', rawPrice, true); });
            priceInput.addEventListener('blur', () => { priceInput.value = formatCurrency(item.price); });
            row.querySelector('.delete-item-btn').addEventListener('click', handleDeleteItem);
            itemsTbody.appendChild(row); autoGrowTextarea(nameTextarea);
         };

        // Update item data in array
        const updateItemData = (id, key, value, recalculate = false) => { /* ... (same as before) ... */
            const itemIndex = invoiceItems.findIndex(item => item.id === id);
            if (itemIndex > -1) { invoiceItems[itemIndex][key] = value; if (recalculate) { updateTotals(); } }
            else { console.warn(`Item with ID ${id} not found during update.`); }
        };

        // Renders all items
        const renderAllItems = () => { /* ... (same as before) ... */
             itemsTbody.innerHTML = ''; invoiceItems.forEach((item) => { if (!item.id) item.id = getNextId(); renderItemRow(item); }); getNextId(); updateTotals(); };

        // --- Item Modal Functions ---
        const handleOpenItemModal = () => { modalItemName.value = ''; modalItemQty.value = '1'; modalItemPrice.value = ''; itemModalOverlay.style.display = 'flex'; modalItemName.focus(); };
        const handleCloseItemModal = () => { itemModalOverlay.style.display = 'none'; };
        const handleSaveItem = () => { /* ... (same as before, uses getNextId, pushes to invoiceItems, calls renderItemRow, updateTotals) ... */
            const name = modalItemName.value.trim(); const qty = getInputValueAsNumber(modalItemQty); const price = getInputValueAsNumber(modalItemPrice);
            if (!name) { alert('Please enter an item description.'); modalItemName.focus(); return; }
            const newItem = { id: getNextId(), name, qty, price }; invoiceItems.push(newItem); renderItemRow(newItem); updateTotals(); handleCloseItemModal();
        };

        // --- Company Modal Functions ---
        const populateCompanyOptions = () => {
            companyOptionsList.innerHTML = ''; // Clear previous options
            companyProfiles.forEach(profile => {
                const label = document.createElement('label');
                label.className = 'company-option';
                const radio = document.createElement('input');
                radio.type = 'radio';
                radio.name = 'company-select';
                radio.value = profile.name; // Store profile name in value
                if (profile.name === currentProfileName) {
                    radio.checked = true; // Pre-select current profile
                }
                const text = document.createElement('span');
                text.textContent = profile.name;

                label.appendChild(radio);
                label.appendChild(text);
                companyOptionsList.appendChild(label);
            });
        };
        const handleOpenCompanyModal = () => {
             populateCompanyOptions(); // Refresh options based on current selection
             companyModalOverlay.style.display = 'flex';
        };
        const handleCloseCompanyModal = () => { companyModalOverlay.style.display = 'none'; };
        const handleApplyCompanySelection = () => {
            const selectedRadio = companyOptionsList.querySelector('input[name="company-select"]:checked');
            if (selectedRadio) {
                const selectedName = selectedRadio.value;
                applyCompanyProfile(selectedName); // Apply the change
                saveDataToLocalStorage(); // Save the new profile selection
            } else {
                alert("Please select a company profile.");
                return; // Don't close if nothing selected
            }
            handleCloseCompanyModal();
        };

        // --- Other Handlers ---
        const handleDeleteItem = (event) => { /* ... (same as before) ... */
             const button = event.target; const idToDelete = parseInt(button.dataset.id, 10); const row = button.closest('tr');
             if (row && confirm('Are you sure you want to delete this item?')) { invoiceItems = invoiceItems.filter(item => item.id !== idToDelete); row.remove(); updateTotals(); }
         };
        const handleAddDiscount = () => { /* ... (same as before) ... */
             const currentDiscount = discountPercent; const discountInput = prompt(`Enter discount percentage (%):`, currentDiscount); if (discountInput === null) return; let newDiscount = parseFloat(discountInput);
             if (isNaN(newDiscount) || newDiscount < 0 || newDiscount > 100) { alert('Please enter a valid discount percentage between 0 and 100.'); return; }
             newDiscount = Math.round(newDiscount * 100) / 100; discountPercent = newDiscount; updateTotals();
        };
        const handlePrint = () => { /* ... (same as before, includes setTimeout) ... */
             document.querySelectorAll('#invoice-items textarea.item-name, #client-details').forEach(autoGrowTextarea);
             const activeElement = document.activeElement; if (activeElement && typeof activeElement.blur === 'function') { activeElement.blur(); }
             setTimeout(() => { window.print(); }, 100);
        };

        // --- Local Storage ---
        const saveDataToLocalStorage = () => {
            const invoiceData = {
                invoiceNumber: invoiceNumberInput.value,
                invoiceDate: invoiceDateInput.value,
                dueDate: dueDateInput.value,
                clientDetails: clientDetailsInput.value,
                items: invoiceItems,
                discount: discountPercent,
                nextId: nextItemId,
                selectedProfileName: currentProfileName // Save selected profile name
            };
            try {
                localStorage.setItem('invoiceGeneratorData', JSON.stringify(invoiceData));
            } catch (e) { console.error("Error saving data to localStorage:", e); }
        };

        const loadDataFromLocalStorage = () => {
             const savedData = localStorage.getItem('invoiceGeneratorData');
             let dataToLoad = {};
             let loadedProfileName = companyProfiles[0].name; // Default

             if (savedData) {
                 try {
                    dataToLoad = JSON.parse(savedData);
                    loadedProfileName = dataToLoad.selectedProfileName || companyProfiles[0].name; // Load saved name or default
                 } catch(e) {
                    console.error("Error parsing saved data:", e);
                    localStorage.removeItem('invoiceGeneratorData'); // Clear corrupted data
                    // Keep default profile name
                 }
             }

             // Apply loaded or default profile FIRST
             applyCompanyProfile(loadedProfileName);

             // Load other invoice data
             invoiceNumberInput.value = dataToLoad.invoiceNumber || '';
             invoiceDateInput.value = dataToLoad.invoiceDate || getDefaultDate();
             dueDateInput.value = dataToLoad.dueDate || '';
             clientDetailsInput.value = dataToLoad.clientDetails || '';
             discountPercent = dataToLoad.discount || 0;
             invoiceItems = dataToLoad.items || [];
             nextItemId = dataToLoad.nextId || 1;

             renderAllItems(); // Render items (triggers totals and save)
             // Ensure loaded textareas are resized correctly
             document.querySelectorAll('#invoice-items textarea.item-name, #client-details').forEach(autoGrowTextarea);
        };

        // Set default values if nothing loaded
        const setDefaultValues = () => {
             applyCompanyProfile(companyProfiles[0].name); // Apply default profile
             invoiceNumberInput.value = '';
             invoiceDateInput.value = getDefaultDate();
             dueDateInput.value = '';
             clientDetailsInput.value = '';
             invoiceItems = [];
             discountPercent = 0;
             nextItemId = 1;
             renderAllItems(); // Render empty (includes save)
             autoGrowTextarea(clientDetailsInput);
        };

        // --- Event Listeners ---
        addItemBtn.addEventListener('click', handleOpenItemModal);
        itemModalSaveBtn.addEventListener('click', handleSaveItem);
        itemModalCancelBtn.addEventListener('click', handleCloseItemModal);
        itemModalOverlay.addEventListener('click', (e) => { if (e.target === itemModalOverlay) handleCloseItemModal(); });

        changeCompanyBtn.addEventListener('click', handleOpenCompanyModal); // Listener for new button
        companyModalOkBtn.addEventListener('click', handleApplyCompanySelection); // Listener for new modal OK
        companyModalCancelBtn.addEventListener('click', handleCloseCompanyModal); // Listener for new modal Cancel
        companyModalOverlay.addEventListener('click', (e) => { if (e.target === companyModalOverlay) handleCloseCompanyModal(); }); // Close on overlay click

        addDiscountBtn.addEventListener('click', handleAddDiscount);
        printBtn.addEventListener('click', handlePrint);

        // Save data on input/change for meta fields & address textareaS
        invoiceNumberInput.addEventListener('input', saveDataToLocalStorage);
        invoiceDateInput.addEventListener('change', saveDataToLocalStorage);
        dueDateInput.addEventListener('change', saveDataToLocalStorage);
        clientDetailsInput.addEventListener('input', () => { autoGrowTextarea(clientDetailsInput); saveDataToLocalStorage(); });
        clientDetailsInput.addEventListener('focus', () => autoGrowTextarea(clientDetailsInput));
        clientDetailsInput.addEventListener('blur', () => autoGrowTextarea(clientDetailsInput));

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
             loadDataFromLocalStorage(); // Load saved data or set defaults
        });

    </script>

</body>
</html>