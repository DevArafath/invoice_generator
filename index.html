<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Generator</title>
    <style>
        /* Basic Reset & Defaults */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { height: 100%; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; background-color: #f4f4f4; color: #333; padding: 20px; min-height: 100%; }

        /* Invoice Container */
        #invoice-container { display: flex; flex-direction: column; min-height: calc(100vh - 40px); max-width: 800px; margin: 20px auto; background-color: #fff; border: 1px solid #ccc; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); }
        #invoice-main-content { flex-grow: 1; padding: 30px; }

        /* Header/Footer Images */
        .invoice-header-img, .invoice-footer-img { width: 100%; display: block; }
        .invoice-header-img { margin-bottom: 20px; }
        .invoice-footer-img { margin-top: auto; padding: 0 30px 30px 30px; }

        /* Invoice Meta Info */
        .invoice-meta { display: flex; justify-content: space-between; margin-bottom: 30px; flex-wrap: wrap; }
        .invoice-meta div { margin-bottom: 10px; min-width: 200px; }
        .invoice-meta label { display: block; font-weight: bold; margin-bottom: 5px; color: #555; }
        .invoice-meta input[type="text"], .invoice-meta input[type="date"], .invoice-meta textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.95em; line-height: 1.4; }
        .invoice-meta textarea { height: 80px; min-height: 40px; resize: none; overflow: auto; }

        /* Items Table */
        #invoice-items { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        #invoice-items th, #invoice-items td { border: 1px solid #ddd; padding: 10px; text-align: left; vertical-align: top; }
        #invoice-items th { background-color: #f0f0f0; font-weight: bold; }
        #invoice-items td.number, #invoice-items th.number { text-align: right; }
        #invoice-items input[type="number"], #invoice-items textarea.item-name { width: 100%; padding: 5px; border: 1px solid #ccc; border-radius: 3px; font-size: 1em; line-height: 1.4; vertical-align: top; }
        #invoice-items td.number input { text-align: right; width: 70px; }
        #invoice-items textarea.item-name { resize: vertical; overflow: hidden; min-height: calc(1.4em + 10px); height: auto; }

        /* Delete Button */
        .delete-item-btn { background-color: #ff4d4d; color: white; border: none; padding: 5px 8px; border-radius: 3px; cursor: pointer; font-size: 0.9em; display: block; margin: 0 auto; }
        .delete-item-btn:hover { background-color: #cc0000; }

        /* Totals Section */
        #invoice-items tfoot td { border: 1px solid #ddd; border-top: 2px solid #aaa; text-align: right; font-weight: bold; padding-top: 8px; padding-bottom: 8px; }
        #invoice-items tfoot tr:first-child td { border-top: 2px solid #aaa; }
        #invoice-items tfoot tr td:first-child { text-align: right; font-weight: bold; color: #333; }

        /* Action Buttons */
        .action-buttons { margin-top: 20px; text-align: right; padding-bottom: 20px; }
        .action-buttons button { color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; margin-left: 10px; transition: background-color 0.3s ease; }
        .action-buttons button#add-item-btn { background-color: #007bff; }
        .action-buttons button#add-item-btn:hover { background-color: #0056b3; }
        .action-buttons button#add-discount-btn { background-color: #ffc107; color: #333; }
        .action-buttons button#add-discount-btn:hover { background-color: #e0a800; }
        /* Style for the new button */
        .action-buttons button#change-company-btn { background-color: #17a2b8; }
        .action-buttons button#change-company-btn:hover { background-color: #138496; }
        .action-buttons button#print-btn { background-color: #6c757d; }
        .action-buttons button#print-btn:hover { background-color: #5a6268; }

        /* Terms and Conditions */
        .terms-conditions { margin-top: 30px; padding-top: 15px; border-top: 1px solid #eee; font-size: 0.85em; color: #555; }
        .terms-conditions h4 { margin-bottom: 5px; font-size: 1.1em; color: #333; }

        /* --- Modal Styles (Shared & Specific) --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 450px; }
        .modal-content h2 { margin-top: 0; margin-bottom: 20px; color: #333; text-align: center; }
        .modal-buttons { text-align: right; margin-top: 20px; }
        .modal-buttons button { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; margin-left: 10px; }

        /* Item Modal Specifics */
        #item-modal-content label { display: block; margin-bottom: 8px; font-weight: bold; }
        #item-modal-content input[type="text"], #item-modal-content input[type="number"] { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; }
        #item-modal-save-btn { background-color: #28a745; color: white; }
        #item-modal-save-btn:hover { background-color: #218838; }
        #item-modal-cancel-btn { background-color: #dc3545; color: white; }
        #item-modal-cancel-btn:hover { background-color: #c82333; }

        /* Company Modal Specifics */
        #company-options-list { max-height: 300px; overflow-y: auto; margin-bottom: 20px; border: 1px solid #eee; padding: 10px; }
        .company-option { display: block; padding: 8px 12px; margin-bottom: 5px; cursor: pointer; border-radius: 4px; transition: background-color 0.2s ease; }
        .company-option:hover { background-color: #f0f0f0; }
        .company-option input[type="radio"] { margin-right: 10px; vertical-align: middle; }
        .company-option span { vertical-align: middle; }
        #company-modal-ok-btn { background-color: #007bff; color: white; }
        #company-modal-ok-btn:hover { background-color: #0056b3; }
        #company-modal-cancel-btn { background-color: #6c757d; color: white; }
        #company-modal-cancel-btn:hover { background-color: #5a6268; }


        /* ============================ */
        /* === PRINT STYLES (Final) === */
        /* ============================ */
        @media print {
            html, body { height: auto; min-height: 0; background-color: #fff; padding: 0; margin: 0; font-size: 10pt; -webkit-print-color-adjust: exact !important; color-adjust: exact !important; }
            #invoice-container { width: 100%; max-width: 100%; min-height: 97vh; height: auto; margin: 0; padding: 0; border: none !important; box-shadow: none !important; display: flex; flex-direction: column; overflow: visible !important; }
            #invoice-main-content { flex-grow: 1; padding: 15mm 15mm 10mm 15mm; width: 100%; }
            .action-buttons, .modal-overlay, .delete-item-btn { display: none !important; }

            /* Style Inputs/TextAreas for Print */
            .invoice-meta input[type="text"], .invoice-meta input[type="date"], .invoice-meta textarea,
            #invoice-items input[type="number"], #invoice-items textarea.item-name {
                border: none !important; border-width: 0 !important; background-color: transparent !important; padding: 0 !important; margin: 0; box-shadow: none !important; outline: none !important; width: 100%; display: block; color: #000 !important; font-family: inherit !important; font-size: inherit !important; line-height: inherit !important; -webkit-appearance: none; -moz-appearance: none; appearance: none;
            }
            .invoice-meta textarea, #invoice-items textarea.item-name { resize: none !important; overflow: hidden !important; height: auto !important; white-space: pre-wrap; word-wrap: break-word; }
            #invoice-items input[type="number"] { text-align: right; width: auto; display: inline; -moz-appearance: textfield; }

            /* Table cells borders in print */
            #invoice-items th, #invoice-items td { border: none !important; border-width: 0 !important; padding: 3px 5px; vertical-align: top; }
            #invoice-items tfoot td { border: none !important; border-width: 0 !important; padding-top: 3px; padding-bottom: 3px; }
            #invoice-items tfoot tr:first-child td { border-top: 1pt solid #888 !important; }

            /* Hide Action column in print */
            #invoice-items thead th:last-child, #invoice-items tbody td:last-child, #invoice-items tfoot td:last-child { display: none !important; }

            /* Header/Footer/Terms Print Handling */
            .invoice-header-img, .invoice-footer-img, .terms-conditions { page-break-inside: avoid !important; }
            .invoice-header-img { display: block !important; width: 100%; margin-bottom: 10mm; }
            .invoice-footer-img { display: block !important; width: 100%; page-break-before: auto; margin-top: auto; padding: 0 15mm 10mm 15mm; }
            .terms-conditions { border-top: none !important; margin-top: 10mm; padding-top: 0; }
        } /* End @media print */

    </style>
</head>
<body>

    <div id="invoice-container">
        <!-- Wrap everything EXCEPT the footer image -->
        <div id="invoice-main-content">

            <!-- 1. Header Image (Source will be set by JS) -->
            <img src="" alt="Company Letterhead Header" id="invoice-header" class="invoice-header-img">

            <!-- 2. Invoice Meta Information -->
            <section class="invoice-meta">
                <div> <label for="invoice-number">Invoice #</label> <input type="text" id="invoice-number" placeholder="e.g., INV-001"> </div>
                <div> <label for="invoice-date">Date Issued</label> <input type="date" id="invoice-date"> </div>
                <div> <label for="due-date">Due Date</label> <input type="date" id="due-date"> </div>
                <div> <label for="client-details">Bill To:</label> <textarea id="client-details" placeholder="Client Name" rows="5"></textarea> </div>
            </section>

            <!-- 3. Invoice Items Table -->
            <table id="invoice-items">
                <thead>
                    <tr> <th>Item Description</th> <th class="number">Qty</th> <th class="number">Unit Price</th> <th class="number">Total</th> <th>Action</th> </tr>
                </thead>
                <tbody id="items-tbody"></tbody>
                <tfoot id="items-tfoot">
                    <tr> <td colspan="3">Subtotal</td> <td id="subtotal" class="number">0.00</td> <td></td> </tr>
                    <tr id="discount-row" style="display: none;"> <td colspan="3">Discount (<span id="discount-percent">0</span>%)</td> <td id="discount-amount" class="number">0.00</td> <td></td> </tr>
                    <tr> <td colspan="3">Grand Total</td> <td id="grand-total" class="number">0.00</td> <td></td> </tr>
                </tfoot>
            </table>

             <!-- 4. Action Buttons -->
            <div class="action-buttons">
                <button id="add-item-btn">Add Item</button>
                <button id="add-discount-btn">Add Discount</button>
                <button id="change-company-btn">Change Company</button> <!-- New Button -->
                <button id="print-btn">Print / Save PDF</button>
            </div>

            <!-- 5. Terms and Conditions -->
            <section class="terms-conditions">
                <h4>Terms & Conditions</h4>
                <p> Sample terms: Payment due within 30 days. Overdue accounts may be subject to interest charges. Goods remain property of the seller until paid in full. </p>
            </section>

        </div> <!-- End #invoice-main-content -->

         <!-- 6. Footer Image (Source will be set by JS) -->
        <img src="" alt="Company Letterhead Footer" id="invoice-footer" class="invoice-footer-img">

    </div><!-- /#invoice-container -->


    <!-- Item Entry Modal -->
    <div id="item-modal-overlay" class="modal-overlay">
        <div id="item-modal-content" class="modal-content">
            <h2>Add Invoice Item</h2>
            <label for="modal-item-name">Item Description:</label>
            <input type="text" id="modal-item-name" placeholder="Enter item name or description">
            <label for="modal-item-qty">Quantity:</label>
            <input type="number" id="modal-item-qty" placeholder="1" min="0" step="any">
            <label for="modal-item-price">Unit Price:</label>
            <input type="number" id="modal-item-price" placeholder="0.00" min="0" step="0.01">
            <div class="modal-buttons">
                <button id="item-modal-save-btn">Save Item</button>
                <button id="item-modal-cancel-btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Company Selection Modal -->
    <div id="company-modal-overlay" class="modal-overlay">
        <div id="company-modal-content" class="modal-content">
            <h2>Select Company Profile</h2>
            <div id="company-options-list">
                <!-- Company options will be populated here by JS -->
            </div>
            <div class="modal-buttons">
                <button id="company-modal-ok-btn">OK</button>
                <button id="company-modal-cancel-btn">Cancel</button>
            </div>
        </div>
    </div>


    <script>
        // --- Configuration: Define Company Profiles ---
        // IMPORTANT: Make sure these paths are correct relative to your HTML file
        // and that the image files exist! Use the `img/` folder.
        const companyProfiles = [
            {
                name: "Default Company",
                header: "img/header_placeholder.png", // Default/fallback
                footer: "img/footer_placeholder.png"
            },
            {
                name: "Creative Solutions Ltd.",
                header: "./img/arafa_design_studios_header.png",   // Example: create this file
                footer: "./img/arafa_design_studios_footer.png"    // Example: create this file
            },
            {
                name: "Tech Innovators Inc.",
                header: "img/tech_header.png",       // Example: create this file
                footer: "img/tech_footer.png"        // Example: create this file
            },
             {
                name: "Global Corp",
                header: "img/global_header.png",       // Example: create this file
                footer: "img/global_footer.png"        // Example: create this file
            },
             {
                name: "Green Energy Co.",
                header: "img/green_header.png",       // Example: create this file
                footer: "img/green_footer.png"        // Example: create this file
            },
            // Add more profiles as needed
        ];

        // --- DOM Elements ---
        const invoiceContainer = document.getElementById('invoice-container');
        const invoiceHeaderImg = document.getElementById('invoice-header'); // Get header img element
        const invoiceFooterImg = document.getElementById('invoice-footer'); // Get footer img element
        const invoiceNumberInput = document.getElementById('invoice-number');
        const invoiceDateInput = document.getElementById('invoice-date');
        const dueDateInput = document.getElementById('due-date');
        const clientDetailsInput = document.getElementById('client-details');
        const itemsTbody = document.getElementById('items-tbody');
        const addItemBtn = document.getElementById('add-item-btn');
        const addDiscountBtn = document.getElementById('add-discount-btn');
        const changeCompanyBtn = document.getElementById('change-company-btn'); // New button
        const printBtn = document.getElementById('print-btn');
        // Item Modal
        const itemModalOverlay = document.getElementById('item-modal-overlay');
        const itemModalSaveBtn = document.getElementById('item-modal-save-btn');
        const itemModalCancelBtn = document.getElementById('item-modal-cancel-btn');
        const modalItemName = document.getElementById('modal-item-name');
        const modalItemQty = document.getElementById('modal-item-qty');
        const modalItemPrice = document.getElementById('modal-item-price');
        // Company Modal
        const companyModalOverlay = document.getElementById('company-modal-overlay'); // New modal overlay
        const companyOptionsList = document.getElementById('company-options-list');   // New list container
        const companyModalOkBtn = document.getElementById('company-modal-ok-btn');     // New OK button
        const companyModalCancelBtn = document.getElementById('company-modal-cancel-btn'); // New Cancel button
        // Totals
        const subtotalEl = document.getElementById('subtotal');
        const discountRow = document.getElementById('discount-row');
        const discountPercentEl = document.getElementById('discount-percent');
        const discountAmountEl = document.getElementById('discount-amount');
        const grandTotalEl = document.getElementById('grand-total');

        // --- State ---
        let invoiceItems = [];
        let discountPercent = 0;
        let nextItemId = 1;
        let currentProfileName = companyProfiles[0].name; // Track current profile name, default to first

        // --- Utility Functions ---
        const formatCurrency = (amount) => { /* ... (same as before) ... */
             const num = Number(amount); return isNaN(num) ? '0.00' : num.toFixed(2); };
        const getInputValueAsNumber = (element) => { /* ... (same as before) ... */
             const value = element.value.trim(); if (value === '') return 0; const num = Number(value); return isNaN(num) || num < 0 ? 0 : num; };
        const getNextId = () => { /* ... (same as before) ... */
             const maxId = invoiceItems.reduce((max, item) => Math.max(max, item.id || 0), 0); nextItemId = Math.max(nextItemId, maxId + 1); return nextItemId++; };
        const autoGrowTextarea = (element) => { /* ... (same as before) ... */
             if (!element) return; const wasHidden = element.style.display === 'none'; if (wasHidden) element.style.display = ''; element.style.height = 'auto'; element.style.height = (element.scrollHeight + 1) + 'px'; if (wasHidden) element.style.display = 'none';};
        const getDefaultDate = () => { /* ... (same as before) ... */
             const today = new Date(); const year = today.getFullYear(); const month = String(today.getMonth() + 1).padStart(2, '0'); const day = String(today.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; };

        // --- Core Functions ---

        // Updates header/footer images based on the profile name
        const applyCompanyProfile = (profileName) => {
            const profile = companyProfiles.find(p => p.name === profileName) || companyProfiles[0]; // Fallback to default
            invoiceHeaderImg.src = profile.header;
            invoiceFooterImg.src = profile.footer;
            invoiceHeaderImg.alt = `${profile.name} Header`; // Update alt text
            invoiceFooterImg.alt = `${profile.name} Footer`; // Update alt text
            currentProfileName = profile.name; // Update state
            console.log("Applied profile:", currentProfileName);
        };

        // Recalculates totals
        const updateTotals = () => { /* ... (same as before, ensures saveDataToLocalStorage is called) ... */
            let currentSubtotal = 0;
            invoiceItems.forEach(item => { currentSubtotal += (item.qty || 0) * (item.price || 0); });
            const discountAmount = currentSubtotal * (discountPercent / 100);
            const grandTotal = currentSubtotal - discountAmount;
            subtotalEl.textContent = formatCurrency(currentSubtotal);
            discountAmountEl.textContent = formatCurrency(discountAmount);
            grandTotalEl.textContent = formatCurrency(grandTotal);
            discountPercentEl.textContent = discountPercent;
            discountRow.style.display = discountPercent > 0 ? '' : 'none';
            itemsTbody.querySelectorAll('tr').forEach(row => {
                const id = parseInt(row.dataset.id, 10);
                const item = invoiceItems.find(i => i.id === id);
                if (item) { const rowTotal = (item.qty || 0) * (item.price || 0); const totalCell = row.querySelector('.item-total'); if(totalCell) totalCell.textContent = formatCurrency(rowTotal); }
            });
            saveDataToLocalStorage();
        };

        // Renders a single item row
        const renderItemRow = (item) => { /* ... (same as before, textarea for name, event listeners) ... */
            const row = document.createElement('tr');
            row.dataset.id = item.id;
            const itemName = item.name || ''; const itemQty = item.qty || 0; const itemPrice = item.price || 0;
            row.innerHTML = `<td><textarea class="item-name" rows="1" placeholder="Item description">${itemName}</textarea></td> <td class="number"><input type="number" class="item-qty" value="${itemQty}" min="0" step="any"></td> <td class="number"><input type="number" class="item-price" value="${formatCurrency(itemPrice)}" min="0" step="0.01"></td> <td class="number item-total">${formatCurrency(itemQty * itemPrice)}</td> <td><button class="delete-item-btn" data-id="${item.id}">X</button></td>`;
            const nameTextarea = row.querySelector('.item-name'); const qtyInput = row.querySelector('.item-qty'); const priceInput = row.querySelector('.item-price');
            nameTextarea.addEventListener('input', () => { autoGrowTextarea(nameTextarea); updateItemData(item.id, 'name', nameTextarea.value); saveDataToLocalStorage(); });
            nameTextarea.addEventListener('focus', () => autoGrowTextarea(nameTextarea)); nameTextarea.addEventListener('blur', () => autoGrowTextarea(nameTextarea));
            qtyInput.addEventListener('input', () => { updateItemData(item.id, 'qty', getInputValueAsNumber(qtyInput), true); });
            priceInput.addEventListener('input', () => { const rawPrice = getInputValueAsNumber(priceInput); updateItemData(item.id, 'price', rawPrice, true); });
            priceInput.addEventListener('blur', () => { priceInput.value = formatCurrency(item.price); });
            row.querySelector('.delete-item-btn').addEventListener('click', handleDeleteItem);
            itemsTbody.appendChild(row); autoGrowTextarea(nameTextarea);
         };

        // Update item data in array
        const updateItemData = (id, key, value, recalculate = false) => { /* ... (same as before) ... */
            const itemIndex = invoiceItems.findIndex(item => item.id === id);
            if (itemIndex > -1) { invoiceItems[itemIndex][key] = value; if (recalculate) { updateTotals(); } }
            else { console.warn(`Item with ID ${id} not found during update.`); }
        };

        // Renders all items
        const renderAllItems = () => { /* ... (same as before) ... */
             itemsTbody.innerHTML = ''; invoiceItems.forEach((item) => { if (!item.id) item.id = getNextId(); renderItemRow(item); }); getNextId(); updateTotals(); };

        // --- Item Modal Functions ---
        const handleOpenItemModal = () => { modalItemName.value = ''; modalItemQty.value = '1'; modalItemPrice.value = ''; itemModalOverlay.style.display = 'flex'; modalItemName.focus(); };
        const handleCloseItemModal = () => { itemModalOverlay.style.display = 'none'; };
        const handleSaveItem = () => { /* ... (same as before, uses getNextId, pushes to invoiceItems, calls renderItemRow, updateTotals) ... */
            const name = modalItemName.value.trim(); const qty = getInputValueAsNumber(modalItemQty); const price = getInputValueAsNumber(modalItemPrice);
            if (!name) { alert('Please enter an item description.'); modalItemName.focus(); return; }
            const newItem = { id: getNextId(), name, qty, price }; invoiceItems.push(newItem); renderItemRow(newItem); updateTotals(); handleCloseItemModal();
        };

        // --- Company Modal Functions ---
        const populateCompanyOptions = () => {
            companyOptionsList.innerHTML = ''; // Clear previous options
            companyProfiles.forEach(profile => {
                const label = document.createElement('label');
                label.className = 'company-option';
                const radio = document.createElement('input');
                radio.type = 'radio';
                radio.name = 'company-select';
                radio.value = profile.name; // Store profile name in value
                if (profile.name === currentProfileName) {
                    radio.checked = true; // Pre-select current profile
                }
                const text = document.createElement('span');
                text.textContent = profile.name;

                label.appendChild(radio);
                label.appendChild(text);
                companyOptionsList.appendChild(label);
            });
        };
        const handleOpenCompanyModal = () => {
             populateCompanyOptions(); // Refresh options based on current selection
             companyModalOverlay.style.display = 'flex';
        };
        const handleCloseCompanyModal = () => { companyModalOverlay.style.display = 'none'; };
        const handleApplyCompanySelection = () => {
            const selectedRadio = companyOptionsList.querySelector('input[name="company-select"]:checked');
            if (selectedRadio) {
                const selectedName = selectedRadio.value;
                applyCompanyProfile(selectedName); // Apply the change
                saveDataToLocalStorage(); // Save the new profile selection
            } else {
                alert("Please select a company profile.");
                return; // Don't close if nothing selected
            }
            handleCloseCompanyModal();
        };

        // --- Other Handlers ---
        const handleDeleteItem = (event) => { /* ... (same as before) ... */
             const button = event.target; const idToDelete = parseInt(button.dataset.id, 10); const row = button.closest('tr');
             if (row && confirm('Are you sure you want to delete this item?')) { invoiceItems = invoiceItems.filter(item => item.id !== idToDelete); row.remove(); updateTotals(); }
         };
        const handleAddDiscount = () => { /* ... (same as before) ... */
             const currentDiscount = discountPercent; const discountInput = prompt(`Enter discount percentage (%):`, currentDiscount); if (discountInput === null) return; let newDiscount = parseFloat(discountInput);
             if (isNaN(newDiscount) || newDiscount < 0 || newDiscount > 100) { alert('Please enter a valid discount percentage between 0 and 100.'); return; }
             newDiscount = Math.round(newDiscount * 100) / 100; discountPercent = newDiscount; updateTotals();
        };
        const handlePrint = () => { /* ... (same as before, includes setTimeout) ... */
             document.querySelectorAll('#invoice-items textarea.item-name, #client-details').forEach(autoGrowTextarea);
             const activeElement = document.activeElement; if (activeElement && typeof activeElement.blur === 'function') { activeElement.blur(); }
             setTimeout(() => { window.print(); }, 100);
        };

        // --- Local Storage ---
        const saveDataToLocalStorage = () => {
            const invoiceData = {
                invoiceNumber: invoiceNumberInput.value,
                invoiceDate: invoiceDateInput.value,
                dueDate: dueDateInput.value,
                clientDetails: clientDetailsInput.value,
                items: invoiceItems,
                discount: discountPercent,
                nextId: nextItemId,
                selectedProfileName: currentProfileName // Save selected profile name
            };
            try {
                localStorage.setItem('invoiceGeneratorData', JSON.stringify(invoiceData));
            } catch (e) { console.error("Error saving data to localStorage:", e); }
        };

        const loadDataFromLocalStorage = () => {
             const savedData = localStorage.getItem('invoiceGeneratorData');
             let dataToLoad = {};
             let loadedProfileName = companyProfiles[0].name; // Default

             if (savedData) {
                 try {
                    dataToLoad = JSON.parse(savedData);
                    loadedProfileName = dataToLoad.selectedProfileName || companyProfiles[0].name; // Load saved name or default
                 } catch(e) {
                    console.error("Error parsing saved data:", e);
                    localStorage.removeItem('invoiceGeneratorData'); // Clear corrupted data
                    // Keep default profile name
                 }
             }

             // Apply loaded or default profile FIRST
             applyCompanyProfile(loadedProfileName);

             // Load other invoice data
             invoiceNumberInput.value = dataToLoad.invoiceNumber || '';
             invoiceDateInput.value = dataToLoad.invoiceDate || getDefaultDate();
             dueDateInput.value = dataToLoad.dueDate || '';
             clientDetailsInput.value = dataToLoad.clientDetails || '';
             discountPercent = dataToLoad.discount || 0;
             invoiceItems = dataToLoad.items || [];
             nextItemId = dataToLoad.nextId || 1;

             renderAllItems(); // Render items (triggers totals and save)
             // Ensure loaded textareas are resized correctly
             document.querySelectorAll('#invoice-items textarea.item-name, #client-details').forEach(autoGrowTextarea);
        };

        // Set default values if nothing loaded
        const setDefaultValues = () => {
             applyCompanyProfile(companyProfiles[0].name); // Apply default profile
             invoiceNumberInput.value = '';
             invoiceDateInput.value = getDefaultDate();
             dueDateInput.value = '';
             clientDetailsInput.value = '';
             invoiceItems = [];
             discountPercent = 0;
             nextItemId = 1;
             renderAllItems(); // Render empty (includes save)
             autoGrowTextarea(clientDetailsInput);
        };

        // --- Event Listeners ---
        addItemBtn.addEventListener('click', handleOpenItemModal);
        itemModalSaveBtn.addEventListener('click', handleSaveItem);
        itemModalCancelBtn.addEventListener('click', handleCloseItemModal);
        itemModalOverlay.addEventListener('click', (e) => { if (e.target === itemModalOverlay) handleCloseItemModal(); });

        changeCompanyBtn.addEventListener('click', handleOpenCompanyModal); // Listener for new button
        companyModalOkBtn.addEventListener('click', handleApplyCompanySelection); // Listener for new modal OK
        companyModalCancelBtn.addEventListener('click', handleCloseCompanyModal); // Listener for new modal Cancel
        companyModalOverlay.addEventListener('click', (e) => { if (e.target === companyModalOverlay) handleCloseCompanyModal(); }); // Close on overlay click

        addDiscountBtn.addEventListener('click', handleAddDiscount);
        printBtn.addEventListener('click', handlePrint);

        // Save data on input/change for meta fields & address textarea
        invoiceNumberInput.addEventListener('input', saveDataToLocalStorage);
        invoiceDateInput.addEventListener('change', saveDataToLocalStorage);
        dueDateInput.addEventListener('change', saveDataToLocalStorage);
        clientDetailsInput.addEventListener('input', () => { autoGrowTextarea(clientDetailsInput); saveDataToLocalStorage(); });
        clientDetailsInput.addEventListener('focus', () => autoGrowTextarea(clientDetailsInput));
        clientDetailsInput.addEventListener('blur', () => autoGrowTextarea(clientDetailsInput));

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
             loadDataFromLocalStorage(); // Load saved data or set defaults
        });

    </script>

</body>
</html>